####################################################################
#  _  __            __ _                       _   _               #
# | |/ /___  _ __  / _(_) __ _ _   _ _ __ __ _| |_(_) ___  _ __    #
# | ' // _ \| '_ \| |_| |/ _` | | | | '__/ _` | __| |/ _ \| '_ \   #
# | . \ (_) | | | |  _| | (_| | |_| | | | (_| | |_| | (_) | | | |  #
# |_|\_\___/|_| |_|_| |_|\__, |\__,_|_|  \__,_|\__|_|\___/|_| |_|  #
#                        |___/                                     #
#   ___  _     _ _  __  __     __  __              _____ 	   #
#  / _ \(_) __| (_) \ \/ /    |  \/  | __ ___  __ |___ / 	   #
# | | | | |/ _` | |  \  /_____| |\/| |/ _` \ \/ /   |_ \ 	   #
# | |_| | | (_| | |  /  \_____| |  | | (_| |>  <   ___) |	   #
#  \__\_\_|\__,_|_| /_/\_\    |_|  |_|\__,_/_/\_\ |____/           #                            
#                                                                  #                                                         
####################################################################

# # This is the printer.cfg for the Qidi X-MAX 3 with Probe-Leveling!!!

[include Macros/Adaptive_Mesh.cfg]
#[include K-ShakeTune/*.cfg]
[include Macros/sensorless_homing_override.cfg]
[include Macros/macros.cfg]
[include Macros/client.cfg]
#[include Macros/timelapse.cfg]

#################################################
#           Prevent error checks                #
#################################################

[duplicate_pin_override]
pins: PA1,PC9
# A comma-separated list of pins that can be used multiple times in
# of a configuration file without normal error checks. This parameter must be
# be specified.


#################################################
#           Printer / MCU settings              #
#################################################
[mcu]
# The hardware uses USART1 PA10/PA9 to connect to RK3328.
serial: /dev/ttyS0
restart_method: command


[mcu MKS_THR]
serial: /dev/serial/by-id/usb-Klipper_rp2040_55D74D153BCB5458-if00
#canbus_uuid: 11aa22bb33cc

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

[printer]
kinematics:corexy
max_velocity: 600
max_accel: 15000
minimum_cruise_ratio: 0.5
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 8

#################################################
#           Extruder / Driver Settings          #
#################################################

[extruder]
step_pin: MKS_THR:gpio5
dir_pin: MKS_THR:gpio4
enable_pin: !MKS_THR:gpio10
rotation_distance: 53.5  #22.6789511	#Bondtech 5mm Drive Gears
gear_ratio: 1628:170		
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 Grad, 400 for 0.9 Grad
nozzle_diameter: 0.400
filament_diameter: 1.75
min_temp: 0
max_temp: 360
min_extrude_temp: 170
smooth_time: 0.000001


heater_pin: MKS_THR:gpio0
sensor_type: MAX6675
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
#   One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".
sensor_pin: MKS_THR:gpio17
#   The chip select line for the sensor chip. This parameter must be
#   provided.
spi_speed: 100000
#   The SPI speed (in hz) to use when communicating with the chip.
#   The default is 4000000.
#spi_bus:spi1
spi_software_sclk_pin: MKS_THR:gpio18
spi_software_mosi_pin: MKS_THR:gpio19
spi_software_miso_pin: MKS_THR:gpio16
#   See the "common SPI settings" section for a description of the
#   above parameters.
#tc_type: K
#tc_use_50Hz_filter: False
#c_averaging_count: 1
#   The above parameters control the sensor parameters of MAX31856
#   chips. The defaults for each parameter are next to the parameter
#   name in the above list.
max_power: 1.0
control: pid  
#pid_Kp: 14.734
#pid_Ki: 6.549 
#pid_Kd: 8.288
pressure_advance: 0.032
pressure_advance_smooth_time: 0.03
max_extrude_cross_section: 500
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 120.0
max_extrude_only_velocity: 5000
max_extrude_only_accel: 2000
step_pulse_duration: 0.000002


[tmc2209 extruder]
uart_pin: MKS_THR: gpio6
interpolate: True
run_current: 0.714
#hold_current: 0.5
#sense_resistor: 0.110
stealthchop_threshold: 0

#################################################
#    X, Y, Z stepper motors / Driver settings   #
#################################################

[stepper_x]
step_pin: PB4
dir_pin: PB3
enable_pin: !PB5
microsteps: 16
rotation_distance: 39.94
full_steps_per_rotation: 200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -7
position_endstop: -7
position_max: 325
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: False
step_pulse_duration: 0.000002

[tmc2209 stepper_x]
uart_pin: PD2
run_current: 1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin: ^PB8
driver_SGTHRS: 85

[stepper_y]
step_pin: PC14
dir_pin: PC13
enable_pin: !PC15
microsteps: 16
rotation_distance: 39.94
full_steps_per_rotation: 200  #set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -9.5
position_endstop: -9.5
position_max: 325
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: False
step_pulse_duration: 0.000002

[tmc2209 stepper_y]
uart_pin: PB9
run_current: 1.07
#hold_current: 0.5
interpolate: True
stealthchop_threshold: 0
diag_pin: ^PC0
driver_SGTHRS: 97

[stepper_z]
step_pin: PC10
dir_pin: PA15
enable_pin: !PC11
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop#!PC3 #for Z-max; endstop have'!' is NO
#position_endstop: 326
position_max: 315
position_min: -6
homing_speed: 10
homing_retract_dist: 8.0
second_homing_speed: 8
homing_positive_dir: false
step_pulse_duration: 0.000002

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.95
#hold_current: 0.6
interpolate: True
stealthchop_threshold: 1200


#################################################
#                  Heating bed                  #
#################################################

[heater_bed]
heater_pin: PC8
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
control: pid
#pid_kp: 71.039
#pid_ki: 2.223
#pid_kd: 567.421
min_temp: -100
max_temp: 125

#################################################
#             Temperature settings              #
#################################################

################### Print head - MCU ############
[temperature_sensor RK3328]
sensor_type: temperature_host
min_temp: 5
max_temp: 80

#[temperature_sensor mcu_temp]
[temperature_sensor STM32F402]
sensor_type: temperature_mcu

# RP4020 Head
[temperature_sensor Toolhead]
sensor_type: temperature_mcu
sensor_mcu: MKS_THR
min_temp: 0
max_temp: 80

################### Assembly space ##############

[heater_generic chamber]
heater_pin: PB10
max_power: 1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA1
control: watermark
max_delta: 1.0
#pid_Kp: 63.418 
#pid_Ki: 1.342 
#pid_Kd: 749.125

min_temp: -100
max_temp: 65 #changed by Qidi in the last update from 70 to 65

[verify_heater chamber]
max_error: 300
check_gain_time: 480
hysteresis: 5
heating_gain: 1

[verify_heater extruder]
max_error: 120
check_gain_time: 20
hysteresis: 5
heating_gain: 1

[verify_heater heater_bed]
max_error: 200
check_gain_time: 60
hysteresis: 5
heating_gain: 1

#################################################
#                   Fans                        #
#################################################

######## Side fan (auxiliary) ###################
[output_pin fan2]
pin: PA8
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

#Radiator cooling from 50C - managed via daughter card MKS-THR
#[heater_fan my_nozzle_fan1]
#pin:PC9
#max_power:1
#shutdown_speed:1
#cycle_time:0.05
#kick_start_time:0.05
#off_below:0
#heater:extruder
#heater_temp:50.0

################### Assembly space fan ################
#Fan extracts internal air via activated carbon filter
[output_pin fan3]
pin: PC9
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.0
scale: 255
shutdown_value: 0.0

[temperature_fan chamber] #fan3
pin: PC9
max_power: 1
#shutdown_speed:
#cycle_time:
hardware_pwm: false
#kick_start_time:
off_below:.1
#   See the "fan" section in example.cfg for a description of the
#   above parameters.
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA1
control: pid
pid_kp: 60
pid_ki: 1
pid_kd: 900
pid_deriv_time: 120
min_temp: 0
max_temp: 90
#   See the "extruder" section in example.cfg for a description of the
#  above parameters.
target_temp: 50.0
#   A temperature (in Celsius) that will be the target temperature.
#  The default is 40 degrees.
max_speed: 1
min_speed: 0.0
gcode_id: chamber #hot

################### Hotend fan  ################
[heater_fan hotend_fan] #FAN0
pin: MKS_THR:gpio1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0

[heater_fan hotend_fan2]
pin: MKS_THR:gpio20
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0

[heater_fan board_fan]
pin: PC4
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0
off_below: 0

################### Component cooling ##################
## FAN0  Filament cooling nozzle
[output_pin fan0]
pin: MKS_THR:gpio2
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0
scale: 255
shutdown_value: 0.0

#################################################
#                 LEDs / Beep                   #
#################################################
[output_pin caselight]
##  Chamber Lighting - In 5V-RGB Position
pin: PC7
pwm: false
shutdown_value: 0
value: 1
#cycle_time: 0.01

[output_pin beeper]
pin: PA2
pwm: false
shutdown_value: 0
value: 0

[output_pin pwc]
pin: PA3
pwm: False
value: 1
shutdown_value: 1

[output_pin sound]
pin: PA13
value: 1

#################################################
#               Filament sensor                 #
#################################################
[filament_switch_sensor fila]
pause_on_runout: True
runout_gcode:
            PAUSE
            SET_FILAMENT_SENSOR SENSOR=fila ENABLE=1
event_delay: 3.0
pause_delay: 0.5
switch_pin: !PC1

#################################################
#           Bed mesh / Leveling tools           #
#################################################
[bed_mesh]
speed: 150               #Speed
horizontal_move_z: 15    #Z-axis height
mesh_min: 25,10          #Minimum position of the detection point
mesh_max: 287,311        #Maximum position of the detection point
probe_count: 9,9         #Number of measuring points - 6x6 - 7x7 etc.
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 4, 4

[probe]
pin: ^!MKS_THR:gpio21
x_offset: 28
y_offset: 4.4
#z_offset: 0.0
speed: 8
samples: 2
samples_result: average
sample_retract_dist: 1.0
samples_tolerance: 0.08
samples_tolerance_retries:3

#################################################
#                 Input shaping                 #
#################################################
[adxl345]
cs_pin: MKS_THR:gpio13
spi_software_sclk_pin: MKS_THR:gpio14
spi_software_mosi_pin: MKS_THR:gpio15
spi_software_miso_pin: MKS_THR:gpio12
axes_map: -x, z, -y

[resonance_tester]
accel_chip: adxl345
probe_points:
    160, 160, 10  # an example

#################################################
#                  Miscellaneous                #
#################################################

#################################################
# client.cfg contains:                          #
#    - virtual_sdcard                           #
#    - pause_resume                             #
#    - display_status                           #
#    - respond                                  #
#################################################


[exclude_object]

[gcode_arcs]
resolution: 0.1 # 1.0

[idle_timeout]
timeout: 86400

#################################################
#                 Auto-Config                   #
#################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 32.468
#*# pid_ki = 12.733
#*# pid_kd = 20.698
#*#
#*# [heater_bed]
#*# pid_kp = 43.256
#*# pid_ki = 1.717
#*# pid_kd = 272.513
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 48.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 39.0
#*#
#*# [probe]
#*# z_offset = 1.854
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-1.062500, -1.063750, -1.073750, -1.071250, -1.097500, -1.106250, -1.090000, -1.117500, -1.102500
#*# 	-1.098750, -1.112500, -1.138750, -1.130000, -1.127500, -1.130000, -1.113750, -1.115000, -1.106250
#*# 	-1.078750, -1.092500, -1.108750, -1.105000, -1.125000, -1.112500, -1.106250, -1.118750, -1.112500
#*# 	-1.078750, -1.075000, -1.108750, -1.098750, -1.107500, -1.130000, -1.131250, -1.126250, -1.106250
#*# 	-1.038750, -1.046250, -1.071250, -1.066250, -1.062500, -1.093750, -1.083750, -1.106250, -1.112500
#*# 	-1.051250, -1.050000, -1.075000, -1.073750, -1.091250, -1.108750, -1.102500, -1.131250, -1.110000
#*# 	-1.001250, -1.017500, -1.031250, -1.037500, -1.052500, -1.073750, -1.070000, -1.106250, -1.112500
#*# 	-1.003750, -1.016250, -1.042500, -1.061250, -1.082500, -1.102500, -1.103750, -1.133750, -1.102500
#*# 	-0.967500, -0.995000, -1.005000, -1.036250, -1.058750, -1.070000, -1.085000, -1.123750, -1.125000
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 287.0
#*# min_y = 10.0
#*# max_y = 310.96
#*#
#*# [bed_mesh kamp]
#*# version = 1
#*# points =
#*# 	  -0.005000, -0.017500, -0.021250
#*# 	  0.016250, 0.015000, -0.001250
#*# 	  0.038750, 0.041250, 0.035000
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 137.0
#*# max_x = 188.0
#*# min_y = 142.5
#*# max_y = 182.5
